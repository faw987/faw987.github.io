<!DOCTYPE html>

<!--WhatIsThis:

    AI movie gridjs table

** faw105 builds on faw98 and 104 and 105 **

-->
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Movie Details</title>
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .gridjs-wrapper {
            margin-top: 20px;
            border: 2px solid #ccc;
        }
        button {
            margin-right: 10px;
            padding: 6px 12px;
            font-size: 14px;
        }
        .clickable-title {
            color: blue;
            cursor: pointer;
            text-decoration: underline;
        }
        #responseText {
            white-space: pre-wrap;
            overflow-y: auto;
            max-height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
<h1>Movie Details</h1>

<form id="inputForm">
    <label for="userInput">Enter your text:</label><br>
    <textarea id="userInput" rows="4" cols="50" placeholder="Type something..."></textarea><br><br>


    <button type="submit">Submit</button>
</form>

<label for="modelSelect">Choose a model:</label><br>
<select id="modelSelect">
    <option value="gpt-4">GPT-4</option>
    <option value="gpt-3.5-turbo">GPT-3.5-Turbo</option>
    <option value="gpt-4o">GPT-4o</option>
    <option value="gpt-4o-mini">GPT-4o-mini</option>
    <option value="o1-preview">o1-preview</option>
    <option value="o1-mini">o1-mini</option>
</select><br><br>

<div id="response">
    <h2>Response:</h2>
    <pre id="responseText">No response yet.</pre>
</div>

<script src="js/util1.js"></script>

<script>

    // model: 'gpt-4o',

    const params = new URLSearchParams(window.location.search);

    // Set text area
    const titleParam = params.get('title');
    if (titleParam) {
        document.getElementById('userInput').value = decodeURIComponent(titleParam);
    }

    // Set model selection
    const modelParam = params.get('model');
    if (modelParam) {
        const modelSelect = document.getElementById('modelSelect');
        const options = Array.from(modelSelect.options);
        const isValidOption = options.some(option => option.value === modelParam);
        if (isValidOption) {
            modelSelect.value = modelParam;
        }
    }

    // Attach the form submit handler
    const form = document.getElementById('inputForm');
    form.addEventListener('submit', handleSubmit);


    async function handleSubmit(event) {
        if (event) event.preventDefault(); // Prevent default form submission behavior
        const userInput = document.getElementById('userInput').value;

        const responseText = document.getElementById('responseText');

        const myPrompt = `tell about this movie: "${userInput}". provide extensive details about the movie. include stars, director, producer. include all trivia regarding the movie.`;

        responseText.textContent = `Invoke LLM (Model: ${document.getElementById('modelSelect').value}) prompt: "${myPrompt}"`;

        invokeModel(myPrompt).then((resp) => {
            console.log(`Response:`, resp);
            responseText.textContent = resp;

            // transformedMovies[row.actualIndex][5] = resp;
            //
            // // Re-render the table with updated data
            // grid.updateConfig({ data: transformedMovies }).forceRender();
        });

    }

    async function invokeModel(prompt) {
        // try {
        // const response = await fetch('https://api.openai.com/v1/chat/completions', {
        const selectedModel = document.getElementById('modelSelect').value;
        console.log(`selectedModel: ${selectedModel}`);
        const response =  await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                "Authorization": `Bearer ${calcResults()}` // Replace with your API key
            },
            body: JSON.stringify({
                model: selectedModel,
                messages: [{role: 'user', content: prompt}]
            })
        })
        // }

        // alert(`response: ${response}`);

        if (!response.ok) {
            throw new Error(`API Error: ${response.statusText}`);
        }

        // const data = await response.json();
        const data =  await response.json();
        const gptResponse = data.choices[0].message.content;
        responseText = gptResponse;
        // alert(`responseText: ${responseText}`);

        // } catch (error) {
        //     responseText = `Error: ${error.message}`;
        // };
        return responseText;
    };

    // Helper function to find movie titles using OpenAI
    function findMovieTitles(inputText, apiKey) {
        // async function findMovieTitles(inputText, apiKey) {
        const apiKey2 = `${calcResults()}`; // Replace with your API key
        // const response = await fetch("https://api.openai.com/v1/chat/completions", {
        const response = fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${apiKey2}`
            },
            body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: [
                    {role: "system", content: 'Identify all movie titles in the given text.'},
                    {
                        role: "user",
                        content: `Extract movie titles from the following text:\n${inputText}.
                    list each title on a seperate line. Do not number the results, just the title please.
                    no extranious punctuation. no leading hyphen.
                    Do not include "The movie title in the given text is" in the output, just the title.
                    double check your work.`
                    }
                ],
                max_tokens: 200
            })
        });
    };

    // http://localhost:63342/faw987.github.io/faw105.html?_ijt=ptg30b3u5eir978i8n4tblt263?movietitlelist=dune,1984,wicked
    // http://faw987.github.io/faw105.html?movietitlelist=dune,1984,wicked

    // const params = new URLSearchParams(window.location.search);
    // alert(params);

    // Set text area
    // const movieTitleList = params.get('movietitlelist');
    // alert(movieTitleList);
    // if (movieTitleList) {
    //     document.getElementById('userInput').value = decodeURIComponent(textParam);
    // }

    //     // Original data: [ID, Title, Year, Genre]
    // let movies = [
    //     [1, "The Matrix", 1999, "Sci-Fi"],
    //     [2, "Inception", 2010, "Action"],
    //     [3, "The Godfather", 1972, "Crime"],
    // ];

    function convertToMoviesStructure(commaSeparatedTitles) {
        // Split the input string into an array of titles
        const titles = commaSeparatedTitles.split(",").map(title => title.trim());

        // Map titles to the desired structure
        const movies = titles.map((title, index) => [
            index + 1,   // Sequential ID
            title,       // Movie title
            1999,        // Default year
            "Other"      // Default genre
        ]);

        return movies;
    }

    // Example usage
    // const input = "The Matrix, Inception, The Godfather";
    // const movies = convertToMoviesStructure(movieTitleList);

    // console.log(movies);

    // Transform movies to include placeholder for Select column
    function transformMovies(movies) {
        return movies.map(row => [null, ...row]);
    }

</script>
</body>
</html>