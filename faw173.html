<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Carol in a Box ‚Äî Alpha</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 12px 20px;
      border-bottom: 1px solid #1f2937;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    header h1 span {
      font-weight: 400;
      opacity: 0.7;
      font-size: 0.9rem;
    }
    main {
      flex: 1;
      display: flex;
      gap: 16px;
      padding: 16px;
    }
    .column {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      overflow: hidden;
      min-height: 0;
    }
    .column-header {
      padding: 10px 12px;
      border-bottom: 1px solid #1f2937;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .column-header span {
      opacity: 0.8;
      font-size: 0.8rem;
    }
    .column-body {
      padding: 8px 12px 12px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .controls {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    button, select {
      border-radius: 999px;
      border: 1px solid #334155;
      background: #020617;
      color: #e5e7eb;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    button.primary {
      background: #22c55e;
      color: #022c22;
      border-color: #22c55e;
      font-weight: 600;
    }
    button.primary.listening {
      background: #ef4444;
      border-color: #ef4444;
      color: #fef2f2;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #0b1120;
      border: 1px solid #1f2937;
      font-size: 0.7rem;
      opacity: 0.9;
    }
    .item {
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px 10px;
      font-size: 0.85rem;
      background: #020617;
    }
    .item-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
      font-size: 0.75rem;
      opacity: 0.8;
    }
    .item-text {
      margin-bottom: 6px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .item-footer {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .item-footer .meta {
      font-size: 0.7rem;
      opacity: 0.7;
    }
    .badge {
      font-size: 0.7rem;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      opacity: 0.9;
    }
    .badge.pending {
      border-color: #f97316;
    }
    .badge.error {
      border-color: #ef4444;
    }
    .badge.done {
      border-color: #22c55e;
    }
    .empty {
      opacity: 0.5;
      font-size: 0.85rem;
      padding: 6px;
    }
    .status-text {
      margin-left: 8px;
      font-size: 0.8rem;
      opacity: 0.8;
    }
    @media (max-width: 800px) {
      main {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>Carol in a Box <span>alpha</span></h1>
  <div class="controls">
    <button id="micButton" class="primary" disabled>Init mic‚Ä¶</button>
    <span id="micStatus" class="status-text"></span>
    <select id="modeSelect">
      <option value="off">Mode: Off</option>
      <option value="light" selected>Mode: Light</option>
      <option value="normal">Mode: Normal</option>
      <option value="deep">Mode: Deep</option>
    </select>
  </div>
</header>

<main>
  <!-- Transcript column -->
  <section class="column">
    <div class="column-header">
      <div>
        Transcript
        <span id="transcriptCount">(0 entries)</span>
      </div>
      <span class="pill">
        üéôÔ∏è Live speech ‚Üí text
      </span>
    </div>
    <div class="column-body" id="transcriptList">
      <div class="empty">Hold the mic button and speak. Final phrases will appear here.</div>
    </div>
  </section>

  <!-- Insights column -->
  <section class="column">
    <div class="column-header">
      <div>
        Carol‚Äôs Thoughts
        <span id="insightCount">(0 insights)</span>
      </div>
      <span class="pill">
        üß† Background deep dives
      </span>
    </div>
    <div class="column-body" id="insightList">
      <div class="empty">Mark something for a deep dive to see Carol‚Äôs analysis here.</div>
    </div>
  </section>
</main>

<script>
  // ---- Global state ----
  const state = {
    listening: false,
    recognition: null,
    utterances: [],   // { id, text, timestamp }
    insights: []      // { id, status, createdAt, sourceText, summary, details, questions[] }
  };

  const micButton = document.getElementById('micButton');
  const micStatus = document.getElementById('micStatus');
  const modeSelect = document.getElementById('modeSelect');
  const transcriptList = document.getElementById('transcriptList');
  const transcriptCount = document.getElementById('transcriptCount');
  const insightList = document.getElementById('insightList');
  const insightCount = document.getElementById('insightCount');

  // ---- Utility ----
  function formatTime(d) {
    const date = d instanceof Date ? d : new Date(d);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  function generateId() {
    return Date.now().toString(36) + '-' + Math.random().toString(36).slice(2);
  }

  // ---- Speech Recognition setup ----
  function initSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      micStatus.textContent = 'Speech recognition not supported in this browser.';
      micButton.disabled = true;
      return;
    }

    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.lang = 'en-US';

    recognition.onstart = () => {
      state.listening = true;
      micButton.textContent = 'Stop listening';
      micButton.classList.add('listening');
      micStatus.textContent = 'Listening‚Ä¶ speak normally.';
    };

    recognition.onend = () => {
      state.listening = false;
      micButton.textContent = 'Start listening';
      micButton.classList.remove('listening');
      micStatus.textContent = 'Stopped.';
    };

    recognition.onerror = (event) => {
      console.error('SpeechRecognition error', event);
      micStatus.textContent = 'Error: ' + event.error;
    };

    recognition.onresult = (event) => {
      // We only store final results, not interims.
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const res = event.results[i];
        if (res.isFinal) {
          const text = res[0].transcript.trim();
          if (text) {
            addUtterance(text);
          }
        }
      }
    };

    state.recognition = recognition;
    micButton.disabled = false;
    micButton.textContent = 'Start listening';
    micStatus.textContent = 'Ready.';
  }

  function toggleListening() {
    if (!state.recognition) return;
    if (state.listening) {
      state.recognition.stop();
    } else {
      try {
        state.recognition.start();
      } catch (e) {
        // Safari sometimes throws if start() is called too quickly.
        console.warn('Recognition start error:', e);
      }
    }
  }

  // ---- Transcript handling ----
  function addUtterance(text) {
    const utterance = {
      id: generateId(),
      text,
      timestamp: new Date().toISOString()
    };
    // Newest first for now
    state.utterances.unshift(utterance);
    renderTranscript();
  }

  function renderTranscript() {
    if (!state.utterances.length) {
      transcriptList.innerHTML = '<div class="empty">No transcript yet. Hold the mic button and speak.</div>';
      transcriptCount.textContent = '(0 entries)';
      return;
    }

    transcriptCount.textContent = `(${state.utterances.length} entr${state.utterances.length === 1 ? 'y' : 'ies'})`;

    const itemsHtml = state.utterances.map(u => {
      const time = formatTime(u.timestamp);
      return `
        <article class="item" data-id="${u.id}">
          <div class="item-header">
            <div>${time}</div>
            <div class="meta">ID: ${u.id.slice(0, 8)}‚Ä¶</div>
          </div>
          <div class="item-text">${escapeHtml(u.text)}</div>
          <div class="item-footer">
            <div>
              <button class="deep-dive-btn" data-action="deep-dive" data-id="${u.id}">
                üß† Deep dive
              </button>
            </div>
            <div class="meta">Mode: ${modeSelect.value}</div>
          </div>
        </article>
      `;
    }).join('');

    transcriptList.innerHTML = itemsHtml;
  }

  // ---- Insights handling ----
  function renderInsights() {
    if (!state.insights.length) {
      insightList.innerHTML = '<div class="empty">No insights yet. Mark a transcript line for a deep dive.</div>';
      insightCount.textContent = '(0 insights)';
      return;
    }

    insightCount.textContent = `(${state.insights.length} insight${state.insights.length === 1 ? '' : 's'})`;

    const itemsHtml = state.insights.map(ins => {
      const time = formatTime(ins.createdAt);
      const statusClass = ins.status === 'pending'
              ? 'pending'
              : ins.status === 'error'
                      ? 'error'
                      : 'done';

      const questionsHtml = (ins.questions && ins.questions.length)
              ? `<ul>${ins.questions.map(q => `<li>${escapeHtml(q)}</li>`).join('')}</ul>`
              : '';

      const detailsHtml = ins.details
              ? `<div class="meta" style="margin-top:4px;">${escapeHtml(ins.details)}</div>`
              : '';

      const sourceHtml = ins.sourceText
              ? `<div class="meta" style="margin-top:6px; opacity:0.6;">Source: ‚Äú${escapeHtml(ins.sourceText)}‚Äù</div>`
              : '';

      return `
        <article class="item">
          <div class="item-header">
            <div>${time}</div>
            <div class="badge ${statusClass}">${ins.status}</div>
          </div>
          <div class="item-text">${escapeHtml(ins.summary || '')}</div>
          ${questionsHtml}
          ${detailsHtml}
          ${sourceHtml}
        </article>
      `;
    }).join('');

    insightList.innerHTML = itemsHtml;
  }

  async function requestDeepDive(utterance) {
    const mode = modeSelect.value;
    if (mode === 'off') {
      alert('Mode is set to Off. Switch to Light/Normal/Deep to request a deep dive.');
      return;
    }

    const tempId = generateId();
    const placeholder = {
      id: tempId,
      status: 'pending',
      createdAt: new Date().toISOString(),
      sourceText: utterance.text,
      summary: `Thinking about: ‚Äú${utterance.text.slice(0, 200)}${utterance.text.length > 200 ? '‚Ä¶' : ''}‚Äù`,
      details: `Mode: ${mode}. Contacting Carol's brain‚Ä¶`,
      questions: []
    };
    state.insights.unshift(placeholder);
    renderInsights();

    try {
      const res = await fetch('/api/deep-dive', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          text: utterance.text,
          timestamp: utterance.timestamp,
          mode
        })
      });

      if (!res.ok) {
        throw new Error('HTTP ' + res.status);
      }

      const data = await res.json();
      placeholder.status = 'done';
      placeholder.summary = data.summary || placeholder.summary;
      placeholder.details = data.details || '';
      placeholder.questions = data.questions || [];
      renderInsights();
    } catch (err) {
      console.error('Deep dive error', err);
      placeholder.status = 'error';
      placeholder.details = 'Error from backend: ' + err.message;
      renderInsights();
    }
  }

  // ---- DOM events ----
  micButton.addEventListener('click', () => {
    toggleListening();
  });

  transcriptList.addEventListener('click', (event) => {
    const button = event.target.closest('button[data-action="deep-dive"]');
    if (!button) return;
    const id = button.dataset.id;
    const utterance = state.utterances.find(u => u.id === id);
    if (utterance) {
      requestDeepDive(utterance);
    }
  });

  // ---- HTML escaping ----
  function escapeHtml(str) {
    return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
  }

  // ---- Init on load ----
  window.addEventListener('load', () => {
    initSpeechRecognition();
  });
</script>
</body>
</html>