<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>7-Day Weather Tables - Drag-and-Drop Locations</title>
    <style>
        :root {
            --bg:#0b1020; --panel:#11172b; --muted:#97a0b3; --text:#e8ecf3; --accent:#6ea8fe; --err:#ff6b6b; --shadow:0 10px 24px rgba(0,0,0,.35);
        }
        body {
            margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, "Noto Sans", sans-serif;
            color:var(--text);
            background: radial-gradient(1250px 800px at 20% -10%, #1a2340, #0b1020 60%);
        }
        .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
        header { display:grid; gap:8px; margin-bottom:16px; }
        h1 { margin:0; font-size: clamp(22px, 2.8vw, 32px); }
        .sub { color: var(--muted); }
        .sr-only { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

        .panel { background:#11172b; border:1px solid #1c2a4d; border-radius:16px; box-shadow: var(--shadow); padding:18px; }
        .controls { display:grid; gap:12px; }
        .row { display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
        @media (max-width: 640px){ .row{ grid-template-columns: 1fr; } }
        label { font-weight:600; font-size:14px; }
        input[type="text"], input[type="file"], textarea {
            width:100%; box-sizing:border-box; padding:10px 12px; border-radius:10px;
            border:1px solid #2a3a6a; background:#0b142c; color:var(--text);
            font-family:inherit;
        }
        textarea { resize:vertical; min-height:60px; }
        .btn { border:1px solid #2a3a6a; color:var(--text); background:#0b142c;
            padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; }
        .btn:hover { background:#12214a; border-color:#3b57a3; }

        .dropzone { border:2px dashed #2a3a6a; border-radius:16px; padding:22px; text-align:center; color:var(--muted); }
        .dropzone.dragover { background: rgba(64,105,215,0.12); border-color: var(--accent); color: var(--text); }

        .grid { display:grid; grid-template-columns: 1fr; gap:16px; margin-top:18px; }
        .card { background: var(--panel); border:1px solid #1b2647; border-radius:16px; padding:12px; box-shadow: var(--shadow); }
        .card h3 { margin:6px 8px 0; font-size:16px; font-weight:700; }
        .meta { color: var(--muted); font-size:12px; margin: 0 8px 6px; }
        .bad { color: var(--err); }

        table.wx { width:100%; border-collapse: collapse; }
        table.wx th, table.wx td { border-bottom:1px solid #25345f; padding:8px 10px; text-align:left; }
        table.wx thead th { position: sticky; top: 0; background:#121a33; z-index:1; }
        table.wx tbody tr:hover { background: rgba(64,105,215,0.08); }
    </style>

    <script type="module" defer>
        // Endpoints
        var GEOCODE = "https://geocoding-api.open-meteo.com/v1/search";
        var FORECAST = "https://api.open-meteo.com/v1/forecast";

        // Minimal WMO -> text mapping
        var WMO = new Map(Object.entries({
            0:"Clear",1:"Mainly clear",2:"Partly cloudy",3:"Overcast",
            45:"Fog",48:"Rime fog",
            51:"Drizzle light",53:"Drizzle mod",55:"Drizzle heavy",
            61:"Rain light",63:"Rain mod",65:"Rain heavy",
            71:"Snow light",73:"Snow mod",75:"Snow heavy",
            80:"Rain showers",81:"Rain shw mod",82:"Rain shw heavy",
            95:"Thunderstorm",96:"Tstorm hail",99:"Tstorm heavy hail"
        }));

        // DOM helper
        function el(tag, attrs, children) {
            if (!attrs) attrs = {};
            if (!children) children = [];
            var e = document.createElement(tag);
            for (var k in attrs) {
                if (!Object.prototype.hasOwnProperty.call(attrs, k)) continue;
                var v = attrs[k];
                if (k === "class") e.className = v;
                else if (k === "text") e.textContent = v;
                else e.setAttribute(k, v);
            }
            if (!Array.isArray(children)) children = [children];
            for (var i=0;i<children.length;i++) {
                var c = children[i];
                if (c) e.append(c);
            }
            return e;
        }

        // Parse one line: "City, State" or "lat,lon" or "lat,lon,desc"
        function parseLine(line){
            var raw = line.split("#")[0].trim();
            if(!raw) return null;
            var m = raw.match(/^\\s*([+-]?\\d+(?:\\.\\d+)?)\\s*,\\s*([+-]?\\d+(?:\\.\\d+)?)\\s*(?:,(.*))?\\s*$/);
            if(m){
                var lat = Number(m[1]), lon = Number(m[2]);
                if(isFinite(lat) && isFinite(lon) && lat>=-90 && lat<=90 && lon>=-180 && lon<=180){
                    var desc = (m[3]||"").trim();
                    return { type:"coords", lat:lat, lon:lon, label: (desc ? desc : (lat.toFixed(3)+","+lon.toFixed(3))) };
                }
            }
            return { type:"place", q: raw };
        }

        function chooseBestResult(results, prefs){
            var wantCountry = prefs.country && prefs.country.trim();
            var wantAdmin1  = prefs.admin1 && prefs.admin1.trim();
            var wantAdmin1LC = wantAdmin1 ? wantAdmin1.toLowerCase() : null;

            function score(r){
                var s = 0;
                if (wantCountry && r.country === prefs.country) s += 2;
                if (wantAdmin1 && r.admin1 && r.admin1.toLowerCase().indexOf(wantAdmin1LC) !== -1) s += 1;
                var pop = r.population || 0;
                return { s:s, pop:pop };
            }

            return results
                .map(function(r){ var sc = score(r); return { r:r, s:sc.s, pop:sc.pop }; })
                .sort(function(a,b){ return (b.s - a.s) || (b.pop - a.pop); })[0].r;
        }

        // Geocode with optional bias
        async function geocode(q, prefs){
            var params = new URLSearchParams({ name:q, count:"5", language:"en" });
            var url = GEOCODE + "?" + params.toString();
            var resp = await fetch(url);
            if(!resp.ok) throw new Error("Geocoding failed " + resp.status);
            var data = await resp.json();
            var results = data.results || [];
            if(results.length === 0) throw new Error("No match for \"" + q + "\"");
            var best;
            if (prefs && ((prefs.country && prefs.country.trim()) || (prefs.admin1 && prefs.admin1.trim()))) {
                best = chooseBestResult(results, prefs);
            } else {
                best = results.sort(function(a,b){ return (b.population||0) - (a.population||0); })[0];
            }
            var labelParts = [];
            if (best.name) labelParts.push(best.name);
            if (best.admin1) labelParts.push(best.admin1);
            if (best.country) labelParts.push(best.country);
            var label = labelParts.join(", ");
            return { lat: best.latitude, lon: best.longitude, label: label };
        }

        async function fetchDaily(lat, lon, days){
            if (!days) days = 7;
            var params = new URLSearchParams({
                latitude: String(lat),
                longitude: String(lon),
                timezone: "auto",
                temperature_unit: "fahrenheit",
                precipitation_unit: "inch",
                forecast_days: String(days),
                daily: [
                    "temperature_2m_max",
                    "temperature_2m_min",
                    "precipitation_sum",
                    "uv_index_max",
                    "wind_gusts_10m_max",
                    "weather_code"
                ].join(",")
            });
            var url = FORECAST + "?" + params.toString();
            var resp = await fetch(url);
            if(!resp.ok){
                var t = "";
                try { t = await resp.text(); } catch(e){}
                throw new Error("Forecast failed " + resp.status + ": " + (t || "(no body)"));
            }
            var json = await resp.json();
            if (json.error) throw new Error(json.reason || "API error");
            return json.daily;
        }

        function buildTable(daily){
            var tbl = el("table", { class:"wx" });
            var thead = el("thead");
            thead.append(el("tr", {}, [
                el("th", { text:"Date" }),
                el("th", { text:"High (F)" }),
                el("th", { text:"Low (F)" }),
                el("th", { text:"Precip (in)" }),
                el("th", { text:"UV" }),
                el("th", { text:"Gust (mph)" }),
                el("th", { text:"Conditions" })
            ]));
            var tbody = el("tbody");
            var n = daily.time.length;
            for(var i=0;i<n;i++){
                var dt = new Date(daily.time[i]);
                var dateStr = dt.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" });
                var hi = daily.temperature_2m_max && daily.temperature_2m_max[i];
                var lo = daily.temperature_2m_min && daily.temperature_2m_min[i];
                var p  = daily.precipitation_sum && daily.precipitation_sum[i];
                var uv = daily.uv_index_max && daily.uv_index_max[i];
                var g  = daily.wind_gusts_10m_max && daily.wind_gusts_10m_max[i];
                var code = daily.weather_code && daily.weather_code[i];
                var cond = (code==null) ? "—" : (WMO.get(String(code)) || String(code));
                tbody.append(el("tr", {}, [
                    el("td", { text: dateStr }),
                    el("td", { text: isFinite(hi) ? hi.toFixed(0) : "–" }),
                    el("td", { text: isFinite(lo) ? lo.toFixed(0) : "–" }),
                    el("td", { text: isFinite(p)  ? p.toFixed(2)  : "–" }),
                    el("td", { text: isFinite(uv) ? uv.toFixed(0) : "–" }),
                    el("td", { text: isFinite(g)  ? g.toFixed(0)  : "–" }),
                    el("td", { text: cond })
                ]));
            }
            tbl.append(thead, tbody);
            return tbl;
        }

        async function buildCard(target, item, prefs){
            var card = el("section", { class:"card", role:"region" });
            var h = el("h3", { text:"Loading..." });
            var meta = el("p", { class:"meta", text:"Resolving location..." });
            card.append(h, meta);
            target.prepend(card);

            try {
                var coords = (item.type === "coords")
                    ? { lat:item.lat, lon:item.lon, label:item.label }
                    : await geocode(item.q, prefs);

                h.textContent = coords.label;
                meta.textContent = "Fetching 7-day forecast...";
                var daily = await fetchDaily(coords.lat, coords.lon, 7);

                var maxUV = Math.max.apply(null, (daily.uv_index_max || [0]));
                var maxG  = Math.max.apply(null, (daily.wind_gusts_10m_max || [0]));
                meta.textContent = "UV max: " + (isFinite(maxUV)? maxUV.toFixed(0): "–") + " • Gust max: " + (isFinite(maxG)? maxG.toFixed(0): "–") + " mph";

                card.append(buildTable(daily));
            } catch(err){
                h.textContent = "Failed to load";
                meta.textContent = String(err && err.message ? err.message : err);
                meta.classList.add("bad");
            }
        }

        // Robust parseAll that handles \n, \r\n, or old Mac \r
        function parseAll(text){
            var norm = text.replace(/\r\n?/g, "\n");
            var lines = norm.split("\n");
            var items = [];
            for (var i=0;i<lines.length;i++){
                var p = parseLine(lines[i]);
                if (p) items.push(p);
            }
            if (items.length === 0) throw new Error("No valid locations found.");
            return items;
        }

        // UI wiring
        var dz = document.getElementById("drop");
        var fileInput = document.getElementById("file");
        var pasteArea = document.getElementById("paste");
        var runBtn = document.getElementById("run");
        var grid = document.getElementById("grid");
        var stateBox = document.getElementById("prefState");
        var countryBox = document.getElementById("prefCountry");

        function clearGrid(){ grid.innerHTML = ""; }

        async function processText(text){
            clearGrid();
            var items = parseAll(text).slice(0, 24);
            var prefs = {
                admin1: (stateBox.value || "").trim(),
                country: (countryBox.value || "").trim()
            };
            for (var i=0;i<items.length;i++){
                await buildCard(grid, items[i], prefs);
            }
        }

        dz.addEventListener("dragover", function(e){ e.preventDefault(); dz.classList.add("dragover"); });
        dz.addEventListener("dragleave", function(){ dz.classList.remove("dragover"); });
        dz.addEventListener("drop", async function(e){
            e.preventDefault(); dz.classList.remove("dragover");
            var f = e.dataTransfer.files && e.dataTransfer.files[0];
            if(!f) return;
            var text = await f.text();
            await processText(text);
        });

        fileInput.addEventListener("change", async function(e){
            var f = e.target.files && e.target.files[0];
            if(!f) return;
            var text = await f.text();
            await processText(text);
            fileInput.value = "";
        });

        runBtn.addEventListener("click", async function(){
            var text = pasteArea.value.trim();
            if(!text){ alert("Paste locations first, or drop a file."); return; }
            await processText(text);
        });
    </script>
</head>
<body>
<div class="wrap">
    <header>
        <h1>7-Day Weather Tables</h1>
        <p class="sub">Drag-and-drop a text file of locations (or paste below). Formats: City, State; lat,lon; or lat,lon,desc.</p>
    </header>

    <section class="panel controls">
        <h2 class="sr-only">Controls</h2>
        <div class="row">
            <div>
                <label for="prefState">Preferred State/Province</label>
                <input id="prefState" type="text" value="New Jersey" />
            </div>
            <div>
                <label for="prefCountry">Preferred Country</label>
                <input id="prefCountry" type="text" value="United States" />
            </div>
        </div>

        <div id="drop" class="dropzone" tabindex="0" aria-label="Drop a locations file here">
            <strong>Drop file here</strong>
            <div class="sub">One location per line. Lines starting with # are ignored.</div>
        </div>

        <div class="row">
            <div>
                <label for="file">Or pick a file</label>
                <input id="file" type="file" accept=".txt,.csv,text/plain" />
            </div>
            <div>
                <label for="paste">Or paste a list</label>
                <textarea id="paste" placeholder="Example:
Piscataway
High Bridge
Metuchen
40.728,-73.995,Greenwich Village"></textarea>
            </div>
        </div>

        <div><button id="run" class="btn" type="button">Generate Tables</button></div>
    </section>

    <section class="grid" id="grid" aria-live="polite" aria-busy="false"></section>
</div>
</body>
</html>