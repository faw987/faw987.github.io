<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Workout/PT/Exercise Coach</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }

    textarea {
      width: 600px;
      height: 340px;
      margin-bottom: 20px;
    }

    label {
      margin-right: 10px;
    }

    .controls, .status {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    #demoButton {
      font-size: 20px;
      padding: 10px 20px;
      background-color: lightgreen;
      border: none;
      cursor: pointer;
    }

  </style>
</head>

<body>
<h1>My Workout/PT/Exercise Coach</h1>
<div class="controls">
  <label for="volume">Volume: </label>
  <input type="range" id="volume" min="0" max="1" step="0.10" value="0.5">
  <output id="volume-output" for="volume">0.5</output>
  <br>

  <label for="rate">Rate: </label>
  <input type="range" id="rate" min="0.1" max="10" step="0.1" value="1">
  <output id="rate-output" for="rate">1</output>
  <br>

  <label for="pitch">Pitch: </label>
  <input type="range" id="pitch" min="0" max="2" step="0.01" value="1">
  <output id="pitch-output" for="pitch">1</output>
  <br>
  <label for="voice">Voice: </label>
  <select id="voice" name="voice"></select>
  <br>
</div>
<div class="status">
  <label>Exercise:</label>
  <input type="text" id="status-exercise" readonly>
  <label>Set:</label>
  <input type="text" id="status-set" readonly>
  <label>Rep:</label>
  <input type="text" id="status-rep" readonly>
  <label>Time Left:</label>
  <input type="text" id="status-time" readonly>
</div>
<label for="text-input">Routine</label>

<!--Exercise	Description	Sets	Reps	Hold	Freq	Pic	Extras-->

<textarea id="text-input" placeholder="Speak or type something...">
  1,exercise one,1,2,5,2,,
  2,exercise two,2,2,3,2,,
  3,three,1,4,30,2,,

  1,supine Chin tucks,1,1,2,2,,

  1,supine Chin tucks,2,3,4,2,,
  2,seated Chin tucks,2,3,4,2,,

  3,Vertical Rotation Stretch,1,4,30,2,,

  1,supine Chin tucks,2,10,10,2,,
  2,seated Chin tucks,2,10,10,2,,
  3,Vertical Rotation Stretch,1,4,30,2,,
</textarea>
<button onclick="speakTextField()">Say</button>
<button onclick="clearText()">Clear</button>
<button onclick="listenText()">Listen</button>
<button onclick="loadData()">Load</button>
<button onclick="processData()">Go</button>
<button id="demoButton" onclick="runDemo()">Demo</button>
<button onclick="test1()">test1</button>


<script>
  let data = [];
  let numberExercises = 0;

  INIT_HOLD = 10
  INIT_MOD = 5

  document.getElementById('status-time').value = INIT_HOLD;
  document.getElementById('status-exercise').value = 1;
  document.getElementById('status-set').value = 1;
  document.getElementById('status-rep').value = 1;

  function getExerciseDetails(table,index){
    console.log(`getExerciseDetails index=${index}`);
    const tableRow = table[index];
    // table.forEach((row, index) => {
    //   console.log(`Processing Row ${index + 1}: "${row}"`);
    //   // console.log(row);
    // });
    return tableRow;
    //
    // console.log(table)
    // console.log(index)
    // console.log(tableRow)

  }


  function test1(){
    let tr = document.getElementById('status-time').value;
    // alert(`tr=${tr}`)
    console.log(`tr=${tr}`)
    setTimeout(test1_1sec,1000)
  }

  function test1_1sec(){
    let tr = document.getElementById('status-time').value;
    console.log(`tr=${tr}`)

    let Exercise = document.getElementById('status-exercise').value;
    let Set = document.getElementById('status-set').value;
    let Rep = document.getElementById('status-rep').value;


    let d = getExerciseDetails(data,Number(Exercise)-1);  // HACK ???????
    const [rExercise, rDescription, rSets, rReps, rHold, rFreq, rPic, rExtras] = d;

    console.log(`d=${rExercise},${rDescription},${d[2]},${d[3]}`)

    if (tr > 0) {
      if(tr % INIT_MOD === 0) {
        t = `${tr} remaining.`;
        speakText(t);
      };
      tr=Number(tr)-1;
      document.getElementById('status-time').value = tr;
      setTimeout(test1_1sec,1000);
    } else {
      t = `Exercise ${Exercise} Set ${Set} Rep ${Rep} complete.`;
      console.log(t);
      // speakText(t);
      appendText('text-input',t);
      speakText("next");
      if (Rep < rReps) {
        document.getElementById('status-rep').value = Number(Rep)+1;
        document.getElementById('status-time').value = rHold;
        setTimeout(test1_1sec,1000);
      } else {
        if (Set < rSets) {
          document.getElementById('status-set').value = Number(Set)+1;
          document.getElementById('status-rep').value = 1;
          setTimeout(test1_1sec,1000);
        } else {
          if (Exercise < numberExercises) {
            document.getElementById('status-exercise').value = Number(Exercise)+1;
            document.getElementById('status-set').value = 1;
            document.getElementById('status-rep').value = 1;
            setTimeout(test1_1sec,1000);
          } else {
            speakText("thats all folks");

          }
        }
      }
    }
  }

  function appendText(id,newText) {
    // Get the textarea element
    var textarea = document.getElementById(id);

    // Get the current text in the textarea
    var currentText = textarea.value;

    // The text to append
    // var newText = "This is the appended text.";

    // Append the new text with a newline character
    textarea.value = currentText + "\n" + newText;
  }


  function doNothing() {
    console.log('Nothing was done!');
  }



  function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }


  async function blockForSeconds(seconds, Exercise, set, rep, Hold) {
    let counter = 0;
    const startTime = new Date().getTime();
    let currentTime = startTime;

    console.log("block seconds: " + seconds);

    while (currentTime < startTime + (seconds * 1000)) {

      // await delay(1000); // 1 second delay

      // setTimeout(doNothing, 100);
      updateStatus(Exercise, set, rep, Hold);
      // setTimeout(doNothing, 100);

      // await delay(1000); // 1 second delay
      delay(1000); // 1 second delay

      currentTime = new Date().getTime();
      counter += 1;
    }

    console.log("Loops executed: " + counter);

  }

  function speakCancel() {
    if ('speechSynthesis' in window) {
      console.log(`speakText cancel()`);
      window.speechSynthesis.cancel();
    } else {
      alert("Sorry, your browser does not support Text to Speech!");
    }
  }
  //
  // function speakTextCallback(text, callback) {
  //   // Create a new speech utterance instance
  //   const utterance = new SpeechSynthesisUtterance(text);
  //
  //   // Attach an event handler for the 'end' event
  //   utterance.onend = function(event) {
  //     console.log('Speech has finished');
  //     if (callback) {
  //       callback();
  //     }
  //   };
  //
  //   // Speak the text
  //   window.speechSynthesis.speak(utterance);
  // }

  function speakText(text) {
    if ('speechSynthesis' in window) {
      // Get voice properties from controls
      let volume = document.getElementById('volume').value;
      let rate = document.getElementById('rate').value;
      let pitch = document.getElementById('pitch').value;
      let voice = document.getElementById('voice').value;

      // window.speechSynthesis.getVoices().forEach(function(voice) {
      //   console.log(voice.name, voice.default ? voice.default :'');
      // });

      let utterance = new SpeechSynthesisUtterance(text);

      // utterance.voice = speechSynthesis.getVoices().filter(function (voice) {
      //   return voice.name == 'Whisper';
      // })[0];

      let selectedVoiceName = document.getElementById('voice').value;
      utterance.voice = speechSynthesis.getVoices().filter(voice => voice.name === selectedVoiceName)[0];

      console.log(utterance.voice);

      utterance.lang = 'en-GB';
      utterance.volume = volume; // 0 to 1
      utterance.rate = rate; // 0.1 to 10
      utterance.pitch = pitch; // 0 to 2
      window.speechSynthesis.speak(utterance);
    } else {
      alert("Sorry, your browser does not support Text to Speech!");
    }
  }

  // In your 'processOneRow' function or wherever appropriate, update status fields:
  // Example:
  function updateStatus(exercise, set, rep, timeLeft) {

    l = `updateStatus >>>  Exercise: ${exercise}, set: ${set}, rep: ${rep}  hold for ${timeLeft} secs.`;
    console.log(`updateStatus >>>  Exercise: ${exercise}, set: ${set}, rep: ${rep}  hold for ${timeLeft} secs.`);

    document.getElementById('status-exercise').value = exercise;
    document.getElementById('status-exercise').innerText = exercise;
    document.getElementById('status-set').value = set;
    document.getElementById('status-set').innerText = set;
    document.getElementById('status-rep').value = rep;
    document.getElementById('status-rep').innerText = rep;
    document.getElementById('status-time').value = timeLeft;
    document.getElementById('status-time').innerText = timeLeft;

    // ti = document.getElementById('text-input');

    appendText('text-input',l);

  }

  // Then, during your processing logic, you'd call:
  // updateStatus(currentExercise, currentSet, currentRep, timeLeft);

  function speakTextField() {
    let text = document.getElementById('text-input').value;
    speakText(text);
  }


  function clearText() {
    document.getElementById('text-input').value = '';
  }

  function listenText() {
    if ('webkitSpeechRecognition' in window) {
      const recognition = new webkitSpeechRecognition();
      recognition.lang = 'en-US';
      recognition.onresult = function(event) {
        document.getElementById('text-input').value = event.results[0][0].transcript;
      };
      recognition.onerror = function(event) {
        alert('Error occurred in recognition: ' + event.error);
      }
      recognition.start();
    } else {
      alert("Sorry, your browser does not support Speech Recognition!");
    }
  }

  function loadData() {
    //
    // console.log('Start');
    //
    // setTimeout(() => {
    //   console.log('After Timeout');
    // }, 3000);
    //
    // console.log('End');

    const textareaValue = document.getElementById('text-input').value;
    const rows = textareaValue.split('\n');
    numberExercises = rows.length;
    data = rows.map(row => row.split(','));
    // alert("Data loaded successfully!");
  }


  // function delay(milliseconds) {
  //   return new Promise(resolve => setTimeout(resolve, milliseconds));
  // }

  async function runExercise(row) {
    const [Exercise, Description, Sets, Reps, Hold, Freq, Pic, Extras] = row;

    for (let set = 1; set <= Sets; set++) {
      console.log(`set ${set}`);
      for (let rep = 1; rep <= Reps; rep++) {
        // console.log(`set ${set}, rep ${rep}  hold for ${Hold}`);
        updateStatus(Exercise, set, rep, Hold);
        speakCancel();
        speakText(`set ${set}, repetition ${rep}, ${Hold} seconds`);
        blockForSeconds(Hold, Exercise, set, rep, Hold);
      }
    }
  }

  function processOneRow(row) {
    const [Exercise, Description, Sets, Reps, Hold, Freq, Pic, Extras] = row;

    console.log("Processing a single row:");
    console.log("Exercise:", Exercise);
    console.log("Description:", Description);
    console.log("Sets:", Sets);
    console.log("Reps:", Reps);
    console.log("Hold:", Hold);
    console.log("Freq:", Freq);
    console.log("Pic:", Pic);
    console.log("Extras:", Extras);

    speakCancel();
    t = `Exercise: ${Exercise}   ${Description}  ${Sets} sets of ${Reps} reps each`;
    console.log("t:", t);

    speakText(t);
    blockForSeconds(5, 1, 2, 3, 4);

    runExercise(row);

    // 10-second delay
    // setTimeout(function() {
    //   console.log("This message appears after 10 seconds");
    // }, 10000); // 10000 milliseconds = 10 seconds


  }

  function processData() {
    if(data.length === 0) {
      alert("No data to process!");
      return;
    }

    const startTimeRoutine = new Date();

    console.log("Processing Data:");
    data.forEach((row, index) => {
      console.log(`Processing Row ${index + 1}:`);
      processOneRow(row);
    });

    const endTimeRoutine = new Date();
    secondsRoutine = (endTimeRoutine - startTimeRoutine)/1000

    console.log(`Complete: ${startTimeRoutine.toString()}   ${endTimeRoutine.toString()}   ${secondsRoutine} seconds.`);

    t = `great job!`;

    speakText(t);
    t = `You finished the routine in ${secondsRoutine} seconds.`;

    speakText(t);

  }

  function runDemo() {
    // Set the demo text
    const demoText = "1,supine Chin tucks,1,2,4,2,,";
    document.getElementById('text-input').value = demoText;
    document.getElementById('text-input').innerText = demoText;

    // Simulate clicking Load and Go buttons
    loadData();
    processData();
  }

    document.getElementById('volume').addEventListener('input', function (event) {
    document.getElementById('volume-output').value = event.target.value;
  });

    document.getElementById('rate').addEventListener('input', function (event) {
    document.getElementById('rate-output').value = event.target.value;
  });

    document.getElementById('pitch').addEventListener('input', function (event) {
    document.getElementById('pitch-output').value = event.target.value;
  });

  window.onload = () => {
    //... any existing onload code...

    // let voiceSelect = document.getElementById('voice');
    // let voices = window.speechSynthesis.getVoices();
    //
    // // Populate the voice select dropdown
    // voices.forEach((voice, i) => {
    //   let option = document.createElement('option');
    //   option.value = voice.name;
    //   option.innerHTML = voice.name + ' (' + voice.lang + ')';
    //   voiceSelect.appendChild(option);
    // });

    let voiceSelect = document.getElementById('voice');

// Hard-coded voice choices
    let voices = [
      {name: 'Samantha', lang: 'en-US'},
      {name: 'Whisper', lang: 'en-US'},
      {name: 'Wobble', lang: 'en-US'},
      {name: 'Xander', lang: 'en-US'},
      {name: 'Sara', lang: 'en-US'}
      // Note: These names and languages are placeholders and may not work if the user's speech synthesis doesn't have them.
    ];

// Populate the voice select dropdown
    voices.forEach((voice, i) => {
      let option = document.createElement('option');
      option.value = voice.name;
      option.innerHTML = voice.name + ' (' + voice.lang + ')';
      voiceSelect.appendChild(option);
    });

    voiceSelect.addEventListener('change', function () {
      console.log('Voice selected:', voiceSelect.value);
      // Additional code to handle voice change...
    });



  };




</script>
</body>

</html>
