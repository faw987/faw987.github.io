<!DOCTYPE html>

<!--WhatIsThis:

    non-Chrome extension driver

    pure html/js driver when input can be pasted.
    should work on ipad and iphone

** faw106 built from faw106

-->

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Movie Magic - faw109</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      width: 400px;
    }
    .hidden {
      display: none;
    }
    #queryInput {
      width: calc(100% - 20px);
      padding: 10px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    #submitQuery {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #0078d7;
      color: white;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }
    #submitQuery:hover {
      background-color: #005a9e;
    }
    .movie-item {
      margin-bottom: 5px;
    }
    button {
      margin-top: 10px;
    }
    .radio-group {
      margin-bottom: 10px;
    }
    .radio-group label {
      margin-right: 10px;
    }
  </style>
</head>
<body>
<h3 id="popupTitle">Movie Magic 0.93</h3>
<br>
<button id="configureButton">Configure</button>

<div class="radio-group">
  <label><input type="radio" name="queryType" value="movies" checked> Movies</label>
  <label><input type="radio" name="queryType" value="actors"> Actors</label>
  <label><input type="radio" name="queryType" value="other"> Other</label>
</div>

<div id="inputContainer">
  <input id="queryInput" type="text" placeholder="Enter text here..." />
  <button id="submitQuery">Search</button>
</div>

<div id="moviesList"></div>
<div class="spacer"></div>
<br>
<button id="getMoreInfo" class="hidden">Get More Info</button>
<button id="setAll">Set All</button> <!-- Added Set All Button -->
<button id="clearAll">Clear All</button> <!-- Added Clear All Button -->
<button id="openMovieTable">Open Movie Table</button>
<button id="openActorTable">Open Actor Table</button>
</body>

<script src="js/util1.js"></script>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    const queryInput = document.getElementById("queryInput");
    const submitQuery = document.getElementById("submitQuery");
    const moviesList = document.getElementById("moviesList");
    const configureButton = document.getElementById("configureButton");
    const queryTypeRadios = document.getElementsByName("queryType");

    configureButton.addEventListener("click", () => {
      chrome.windows.create({
        url: "config.html",
        type: "popup",
        width: 350,
        height: 400
      });
    });

    function getSelectedQueryType() {
      return [...queryTypeRadios].find(radio => radio.checked)?.value || "movies";
    }

    async function handleSearch() {
      const userQuery = queryInput.value.trim();
      const queryType = getSelectedQueryType();
      console.log(`Query Type: ${queryType}, Query: ${userQuery}`);

      if (userQuery) {
        let results;
        try {
          results = await findTitles(userQuery, queryType);
        } catch (error) {
          alert(`Error fetching titles: ${error.message}`);
          return;
        }

        moviesList.innerHTML = ""; // Clear previous results

        if (queryType === "movies") {
          buildHtmlMovies(results, moviesList);
        } else if (queryType === "actors") {
          buildHtmlActors(results, moviesList);
        } else if (queryType === "other") {
          buildHtmlOthers(results, moviesList); // Placeholder for "Other"
        }
      } else {
        alert("Please enter a valid query.");
      }
    }

    submitQuery.addEventListener("click", handleSearch);
    queryInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        handleSearch();
      }
    });
  });

  function buildHtmlMovies(movies, moviesList) {
    movies.forEach((movie) => {
      const item = document.createElement("div");
      item.className = "movie-item";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = movie;

      const link = document.createElement("a");
      link.textContent = movie;
      link.href = `https://faw987.github.io/faw106.html?title=${movie}&submit=true`;
      link.target = "_blank";

      item.appendChild(checkbox);
      item.appendChild(link);
      moviesList.appendChild(item);
    });
  }

  function buildHtmlActors(actors, moviesList) {
    actors.forEach((actor) => {
      const item = document.createElement("div");
      item.className = "movie-item";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = actor;

      const link = document.createElement("a");
      link.textContent = actor;
      link.href = `https://faw987.github.io/faw108.html?actor=${actor}&submit=true`;
      link.target = "_blank";

      item.appendChild(checkbox);
      item.appendChild(link);
      moviesList.appendChild(item);
    });
  }

  function buildHtmlOthers(others, moviesList) {
    others.forEach((other) => {
      const item = document.createElement("div");
      item.className = "movie-item";

      const text = document.createElement("span");
      text.textContent = other;

      item.appendChild(text);
      moviesList.appendChild(item);
    });
  }

  async function findTitles(inputText, type) {
    const typePrompt = {
      movies: "Identify all movie titles",
      actors: "Identify all actor names",
      other: "Identify all other related items"
    }[type];

    const apiKey2 = `${calcResults()}`; // Replace with your API key
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${apiKey2}`
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [
          { role: "system", content: `${typePrompt} in the given text.` },
          {
            role: "user",
            content: `Extract ${typePrompt.toLowerCase()} from the following text:\n${inputText}.
                      List each on a separate line. No numbering or punctuation.`
          }
        ],
        max_tokens: 200
      })
    });

    if (!response.ok) {
      throw new Error(`API error: ${response.statusText}`);
    }

    const data = await response.json();
    const resultText = data.choices[0]?.message?.content?.trim();
    return resultText ? resultText.split("\n").map(line => line.trim()) : [];
  }
</script>
</html>