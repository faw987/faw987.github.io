<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Three-JS Drone Simulator</title>
    <style>
        html,body{margin:0;height:100%;overflow:hidden}
        #hud{
            position:fixed;
            top:10px;
            left:10px;
            color:#fff;
            font-family:monospace;
            background:rgba(0,0,0,.55);
            padding:8px 12px;
            border-radius:8px;
            z-index:10;
        }
        #help{
            position:fixed;
            bottom:10px;
            left:10px;
            color:#fff;
            font-family:sans-serif;
            background:rgba(0,0,0,.35);
            padding:6px 10px;
            border-radius:6px;
            z-index:10;
        }
        canvas{display:block}
    </style>
</head>
<body>
<div id="hud">Speed: 0 m/s<br>Altitude: 0 m</div>
<div id="help">W/A/S/D: move • SPACE: ascend • SHIFT: descend • V: change view</div>

<!-- Import-map resolves the bare specifier "three" to the latest CDN build -->
<script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@latest/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@latest/examples/jsm/"
      }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    /* ─────────── Renderer & Scene ─────────── */
    const renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb); // sky-blue

    /* ─────────── Ground & Roads ─────────── */
    const loader = new THREE.TextureLoader();
    const asphalt = loader.load('https://threejsfundamentals.org/threejs/resources/images/floor.jpg');
    asphalt.wrapS = asphalt.wrapT = THREE.RepeatWrapping;
    asphalt.repeat.set(50,50);

    const ground = new THREE.Mesh(
        new THREE.PlaneGeometry(500,500),
        new THREE.MeshStandardMaterial({ map: asphalt })
    );
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    // Grid-like road layout (dark asphalt strips)
    const roadMat = new THREE.MeshStandardMaterial({ color:0x303030 });
    const roadW = 10;
    for(let i=-200;i<=200;i+=40){
        const vert = new THREE.Mesh(new THREE.BoxGeometry(roadW,0.1,500), roadMat);
        vert.position.set(i,0.05,0);
        scene.add(vert);

        const horiz = new THREE.Mesh(new THREE.BoxGeometry(500,0.1,roadW), roadMat);
        horiz.position.set(0,0.05,i);
        scene.add(horiz);
    }

    /* ─────────── Buildings ─────────── */
    const wallTex = loader.load('https://threejsfundamentals.org/threejs/resources/images/wall.jpg');
    wallTex.wrapS = wallTex.wrapT = THREE.RepeatWrapping;
    for(let i=0;i<100;i++){
        const h = THREE.MathUtils.randInt(5,30);
        const bld = new THREE.Mesh(
            new THREE.BoxGeometry(10,h,10),
            new THREE.MeshStandardMaterial({ map: wallTex })
        );
        const x = THREE.MathUtils.randFloatSpread(400);
        const z = THREE.MathUtils.randFloatSpread(400);
        if(Math.abs(x%40) < 15 && Math.abs(z%40) < 15) continue; // keep streets clear
        bld.position.set(x,h/2,z);
        scene.add(bld);
    }

    /* ─────────── Simple Traffic ─────────── */
    const cars = [];
    for(let i=0;i<20;i++){
        const mat = new THREE.MeshStandardMaterial({ color: new THREE.Color().setHSL(Math.random(),0.8,0.5) });
        const car = new THREE.Mesh(new THREE.BoxGeometry(4,2,6), mat);
        const lane = THREE.MathUtils.randInt(-4,4)*40;
        car.position.set(lane,1,THREE.MathUtils.randFloatSpread(500));
        car.userData.speed = THREE.MathUtils.randFloat(5,15)*(Math.random()<0.5?-1:1);
        scene.add(car);
        cars.push(car);
    }

    /* ─────────── Lights ─────────── */
    scene.add(new THREE.HemisphereLight(0xffffff,0x444444,0.8));
    const sun = new THREE.DirectionalLight(0xffffff,0.8);
    sun.position.set(50,100,0);
    scene.add(sun);

    /* ─────────── Drone ─────────── */
    const drone = new THREE.Group();
    const chassis = new THREE.Mesh(new THREE.BoxGeometry(4,1,4), new THREE.MeshStandardMaterial({ color:0x2222ff }));
    drone.add(chassis);
    drone.position.set(0,5,0);
    scene.add(drone);

    /* ─────────── Camera & Controls ─────────── */
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
    const orbit = new OrbitControls(camera, renderer.domElement);
    orbit.enabled = false; // disabled for game feel

    let viewMode = 0; // 0-FP, 1-overhead, 2-behind

    /* ─────────── Input Handling ─────────── */
    const keys = {};
    window.addEventListener('keydown', e=>{
        keys[e.code] = true;
        if(e.code === 'KeyV') viewMode = (viewMode + 1) % 3;
    });
    window.addEventListener('keyup', e=> keys[e.code] = false);

    /* ─────────── Movement Physics ─────────── */
    let velocity = new THREE.Vector3();
    const thrust = 0.2;
    const drag = 0.95;

    function controlDrone(){
        const dir = new THREE.Vector3();
        if(keys['KeyW']) dir.z -= 1;
        if(keys['KeyS']) dir.z += 1;
        if(keys['KeyA']) dir.x -= 1;
        if(keys['KeyD']) dir.x += 1;
        dir.normalize();

        // world-space direction (drone faces -Z by design)
        velocity.addScaledVector(dir.applyQuaternion(drone.quaternion), thrust);

        if(keys['Space']) velocity.y += thrust;
        if(keys['ShiftLeft'] || keys['ShiftRight']) velocity.y -= thrust;

        velocity.multiplyScalar(drag);
        drone.position.add(velocity);
        drone.position.y = Math.max(1, drone.position.y); // prevent tunneling ground
    }

    /* ─────────── Cars Update ─────────── */
    function moveCars(dt){
        cars.forEach(c=>{
            c.position.z += c.userData.speed*dt;
            if(c.position.z > 250) c.position.z = -250;
            if(c.position.z < -250) c.position.z = 250;
        });
    }

    /* ─────────── Camera Modes ─────────── */
    function updateCamera(){
        switch(viewMode){
            case 0: // First-person
                camera.position.copy(drone.position).add(new THREE.Vector3(0,2,0));
                camera.rotation.copy(drone.rotation);
                camera.translateZ(-2);
                break;
            case 1: // Overhead
                camera.position.lerpVectors(camera.position, drone.position.clone().add(new THREE.Vector3(0,80,0)), 0.1);
                camera.lookAt(drone.position);
                break;
            case 2: // Behind / chase
                const desired = drone.position.clone().add(new THREE.Vector3(0,5,12).applyQuaternion(drone.quaternion));
                camera.position.lerp(desired, 0.15);
                camera.lookAt(drone.position);
                break;
        }
    }

    /* ─────────── HUD ─────────── */
    const hud = document.getElementById('hud');

    /* ─────────── Animation Loop ─────────── */
    let prev = performance.now();
    renderer.setAnimationLoop(()=>{
        const now = performance.now();
        const dt = (now - prev) / 1000;
        prev = now;

        controlDrone();
        moveCars(dt);
        updateCamera();

        hud.innerHTML = `Speed: ${velocity.length().toFixed(1)} m/s<br>Altitude: ${drone.position.y.toFixed(1)} m`;

        renderer.render(scene, camera);
    });

    /* ─────────── Resize Handling ─────────── */
    window.addEventListener('resize', ()=>{
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>